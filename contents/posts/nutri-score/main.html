<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.446">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Thomas Camminady">
<meta name="dcterms.date" content="2023-06-29">

<title>Dr.&nbsp;Thomas Camminady - Nutriscore analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0JJXC6PKGJ"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0JJXC6PKGJ', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<meta property="og:title" content="Dr.&nbsp;Thomas Camminady - Nutriscore analysis">
<meta property="og:description" content="">
<meta property="og:site_name" content="Dr. Thomas Camminady">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Dr.&nbsp;Thomas Camminady</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">It’s me, hi!</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../contents/CVen.pdf"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../contents/blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../contents/datasets.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/thomascamminady"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/camminady/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/camminady"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/thomascamminady/blog"> <i class="bi bi-code" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Nutriscore analysis</h1>
  <div class="quarto-categories">
    <div class="quarto-category">analysis</div>
    <div class="quarto-category">nutriscore</div>
  </div>
  </div>



<div class="quarto-title-meta column-page">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Thomas Camminady </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 29, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div id="cell-1" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># %load_ext autoreload</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># %autoreload 2</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> collections</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> os</span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="im">from</span> camminapy.plot <span class="im">import</span> altair_setup, altair_theme</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">from</span> sklearn <span class="im">import</span> tree</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> Normalizer</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="im">from</span> blog <span class="im">import</span> logger</span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="im">from</span> blog.io <span class="im">import</span> (</span>
<span id="cb1-19"><a href="#cb1-19"></a>    ConvertDatetimeStrings,</span>
<span id="cb1-20"><a href="#cb1-20"></a>    ConvertNutrientsToFloats,</span>
<span id="cb1-21"><a href="#cb1-21"></a>    ConvertNutriScoresToCapitalLetters,</span>
<span id="cb1-22"><a href="#cb1-22"></a>    FilterGermany,</span>
<span id="cb1-23"><a href="#cb1-23"></a>    HasNutriScore,</span>
<span id="cb1-24"><a href="#cb1-24"></a>    KeepOnlyEnglishVersion,</span>
<span id="cb1-25"><a href="#cb1-25"></a>    KeepOnlyTagsVersion,</span>
<span id="cb1-26"><a href="#cb1-26"></a>    ValidCode,</span>
<span id="cb1-27"><a href="#cb1-27"></a>)</span>
<span id="cb1-28"><a href="#cb1-28"></a></span>
<span id="cb1-29"><a href="#cb1-29"></a>alt.data_transformers.disable_max_rows()</span>
<span id="cb1-30"><a href="#cb1-30"></a>altair_theme()</span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="co"># altair_setup()</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>logger.setLevel(<span class="st">"ERROR"</span>)</span>
<span id="cb1-33"><a href="#cb1-33"></a></span>
<span id="cb1-34"><a href="#cb1-34"></a>load_from_disk <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>final_df_path <span class="op">=</span> (</span>
<span id="cb1-36"><a href="#cb1-36"></a>    <span class="st">"/Users/thomascamminady/Repos/blog/contents/posts/nutri-score/df.parquet"</span></span>
<span id="cb1-37"><a href="#cb1-37"></a>)</span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="cf">if</span> load_from_disk <span class="kw">and</span> os.path.exists(final_df_path):</span>
<span id="cb1-39"><a href="#cb1-39"></a>    df <span class="op">=</span> pl.read_parquet(final_df_path)</span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="cf">else</span>:</span>
<span id="cb1-41"><a href="#cb1-41"></a>    path_csv <span class="op">=</span> <span class="st">"en.openfoodfacts.org.products.csv"</span></span>
<span id="cb1-42"><a href="#cb1-42"></a>    path_parquet <span class="op">=</span> path_csv.replace(<span class="st">".csv"</span>, <span class="st">".parquet"</span>)</span>
<span id="cb1-43"><a href="#cb1-43"></a>    <span class="cf">if</span> os.path.exists(path_parquet):</span>
<span id="cb1-44"><a href="#cb1-44"></a>        logger.info(<span class="st">"Reading from .parquet file"</span>)</span>
<span id="cb1-45"><a href="#cb1-45"></a>        _df <span class="op">=</span> pl.read_parquet(<span class="st">"en.openfoodfacts.org.products.parquet"</span>)</span>
<span id="cb1-46"><a href="#cb1-46"></a>    <span class="cf">else</span>:</span>
<span id="cb1-47"><a href="#cb1-47"></a>        logger.info(<span class="st">"Reading from .csv file."</span>)</span>
<span id="cb1-48"><a href="#cb1-48"></a>        _df <span class="op">=</span> pl.read_csv(path_csv, separator<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, ignore_errors<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-49"><a href="#cb1-49"></a>        _df.write_parquet(path_parquet)</span>
<span id="cb1-50"><a href="#cb1-50"></a></span>
<span id="cb1-51"><a href="#cb1-51"></a>    df <span class="op">=</span> (</span>
<span id="cb1-52"><a href="#cb1-52"></a>        _df.pipe(FilterGermany)  <span class="co"># We focus on products sold in Germany.</span></span>
<span id="cb1-53"><a href="#cb1-53"></a>        .pipe(HasNutriScore)  <span class="co"># We want products that have a non-null Nutriscore.</span></span>
<span id="cb1-54"><a href="#cb1-54"></a>        .pipe(ConvertNutrientsToFloats)  <span class="co"># Change dtype of columns with nutrients.</span></span>
<span id="cb1-55"><a href="#cb1-55"></a>        .pipe(ConvertDatetimeStrings)  <span class="co"># Change dtype to be Datetime.</span></span>
<span id="cb1-56"><a href="#cb1-56"></a>        .pipe(KeepOnlyEnglishVersion)  <span class="co"># Some duplicate columns, remove unwanted.</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>        .pipe(KeepOnlyTagsVersion)  <span class="co"># Some duplicate columns, remove unwanted.</span></span>
<span id="cb1-58"><a href="#cb1-58"></a>        .pipe(ValidCode)  <span class="co"># Product code needs to be non-null and unique.</span></span>
<span id="cb1-59"><a href="#cb1-59"></a>        .pipe(ConvertNutriScoresToCapitalLetters)</span>
<span id="cb1-60"><a href="#cb1-60"></a>    )</span>
<span id="cb1-61"><a href="#cb1-61"></a>    df.write_parquet(final_df_path)</span>
<span id="cb1-62"><a href="#cb1-62"></a></span>
<span id="cb1-63"><a href="#cb1-63"></a>n_non_nutrients <span class="op">=</span> <span class="bu">len</span>([c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="kw">not</span> c.endswith(<span class="st">"_100g"</span>)])</span>
<span id="cb1-64"><a href="#cb1-64"></a>n_nutrients <span class="op">=</span> <span class="bu">len</span>([c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> c.endswith(<span class="st">"_100g"</span>)])</span>
<span id="cb1-65"><a href="#cb1-65"></a>logger.info(<span class="ss">f"""Number of columns excluding nutrients: </span><span class="sc">{</span>n_non_nutrients<span class="sc">}</span><span class="ss">"""</span>)</span>
<span id="cb1-66"><a href="#cb1-66"></a>logger.info(<span class="ss">f"""Number of nutrients columns: </span><span class="sc">{</span>n_nutrients<span class="sc">}</span><span class="ss">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="the-data" class="level1">
<h1>The Data</h1>
<p>The data is taken from <a href="https://world.openfoodfacts.org/data">Open Food Facts</a> where it is available for download under the <a href="https://opendatacommons.org/licenses/odbl/1-0/">Open Database License</a>.</p>
<p>I downloaded <code>en.openfoodfacts.org.products.csv</code> which is and 8.2GB file, containing 2.9 million products with 203 attributes stored per product, such as name, origin, sugar per 100g, etc.</p>
<p>To be able to work with this data, a couple of pre-processing steps and selections are executed which we will layout here with justifications if necessary:</p>
<ul>
<li><strong>Products must be sold in Germany.</strong> (I am German and I wanted to at least know some of the products. It also made my life easier because it reduces the amount of data by roughly a factor of 10.)</li>
<li><strong>Products must have a valid Nutriscore.</strong> (The whole point of this analysis is to have a look at the Nutriscore, so items with a <code>null</code> Nutriscore are discarded. This reduces the data by another 3x.)</li>
<li><strong>Remove redundant information.</strong> (Some columns are redundant as they contain the same content, just in a different format. This drops about 25 columns.)</li>
<li><strong>Remove products with non-unique IDs.</strong> (This drops another couple of rows.)</li>
</ul>
<p>Executing all these steps, we are left with around 73k products and 175 columns corresponding to different data fields. Out of those 175 columns, 118 contain information about the nutrients (per 100g).</p>
<p>Here’s how the number of products split up across the different Nutriscores.</p>
<div id="cell-3" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>df.groupby(<span class="st">"nutriscore_grade"</span>, maintain_order<span class="op">=</span><span class="va">True</span>).count().sort(<span class="st">"nutriscore_grade"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It is important to note, that products are listed in the data base multiple times, often because they occur in different portion sizes. For example, here are all products that are named “Snickers”.</p>
<div id="cell-5" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>df.<span class="bu">filter</span>(pl.col(<span class="st">"product_name"</span>) <span class="op">==</span> <span class="st">"Snickers"</span>).select(<span class="st">"product_name"</span>, <span class="st">"quantity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="nutriscore-101" class="level1">
<h1>Nutriscore 101</h1>
<p>The <a href="https://www.bmel.de/DE/themen/ernaehrung/lebensmittel-kennzeichnung/freiwillige-angaben-und-label/nutri-score/nutri-score_node.html">Nutriscore</a> shall serve as a tool that allows to quickly compare products. The score can be one of “A”, “B”, “C”, “D”, or “E”. However, there is also an actual numeric score underpinning the grade.</p>
<p>(Note that while the official Nutriscore has a green-to-red scale, we are using a blue-to-red scale to ensure better readability for people with colorblindness.)</p>
<p>This is shown in the next graph which presents the histogram of these numeric scores, colored by their Nutriscore grade.</p>
<div id="cell-7" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>c <span class="op">=</span> <span class="st">"nutriscore_grade"</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>color <span class="op">=</span> (</span>
<span id="cb4-3"><a href="#cb4-3"></a>    alt.Color(<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">:N"</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a>    .scale(</span>
<span id="cb4-5"><a href="#cb4-5"></a>        zero<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>        domain<span class="op">=</span>[<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>],</span>
<span id="cb4-7"><a href="#cb4-7"></a>        <span class="co"># scheme="darkmulti",</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>        <span class="bu">range</span><span class="op">=</span>[<span class="st">"blue"</span>, <span class="st">"lightblue"</span>, <span class="st">"gold"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>],</span>
<span id="cb4-9"><a href="#cb4-9"></a>    )</span>
<span id="cb4-10"><a href="#cb4-10"></a>    .legend(columns<span class="op">=</span><span class="dv">1</span>, symbolLimit<span class="op">=</span><span class="dv">0</span>, labelLimit<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-11"><a href="#cb4-11"></a>)</span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a>alt.Chart(</span>
<span id="cb4-14"><a href="#cb4-14"></a>    df.select(<span class="st">"nutriscore_grade"</span>, <span class="st">"nutriscore_score"</span>)  <span class="co"># .sample(5_000)</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>).mark_bar().encode(</span>
<span id="cb4-16"><a href="#cb4-16"></a>    x<span class="op">=</span>alt.X(<span class="st">"nutriscore_score:Q"</span>).<span class="bu">bin</span>(step<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb4-17"><a href="#cb4-17"></a>    y<span class="op">=</span>alt.Y(<span class="st">"count():Q"</span>),</span>
<span id="cb4-18"><a href="#cb4-18"></a>    color<span class="op">=</span>color,</span>
<span id="cb4-19"><a href="#cb4-19"></a>    row<span class="op">=</span><span class="st">"nutriscore_grade:N"</span>,</span>
<span id="cb4-20"><a href="#cb4-20"></a>).properties(</span>
<span id="cb4-21"><a href="#cb4-21"></a>    height<span class="op">=</span><span class="dv">150</span>, width<span class="op">=</span><span class="dv">700</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>).resolve_scale(</span>
<span id="cb4-23"><a href="#cb4-23"></a>    y<span class="op">=</span><span class="st">"independent"</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This mostly agrees with what I could find <a href="https://www.eurofins.de/food-analysis/food-news/food-testing-news/nutri-score/#">online</a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="main_files/figure-html/cell-8-1-image.png" class="img-fluid figure-img" width="600"></p>
<figcaption>Nutriscore.jpeg</figcaption>
</figure>
</div>
<p>Interestingly, there are a number of products that have an “E” grade but a lower numeric Nutriscore. Looking at a random selection of those, it seems that these are mostly beverages containing sugar.</p>
<div id="cell-9" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="bu">print</span>(</span>
<span id="cb5-2"><a href="#cb5-2"></a>    df.<span class="bu">filter</span>(pl.col(<span class="st">"nutriscore_grade"</span>) <span class="op">==</span> <span class="st">"E"</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a>    .<span class="bu">filter</span>(pl.col(<span class="st">"nutriscore_score"</span>) <span class="op">&lt;</span> <span class="dv">18</span>)</span>
<span id="cb5-4"><a href="#cb5-4"></a>    .select(<span class="st">"product_name"</span>, <span class="st">"categories_en"</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a>    .sort(<span class="st">"categories_en"</span>)</span>
<span id="cb5-6"><a href="#cb5-6"></a>    .sample(n<span class="op">=</span><span class="dv">20</span>)[<span class="st">"product_name"</span>]</span>
<span id="cb5-7"><a href="#cb5-7"></a>    .to_list()</span>
<span id="cb5-8"><a href="#cb5-8"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we can have a look at some of the nutrients. Let’s plot fat per 100g against sugar per 100g and group everything by Nutriscore.</p>
<div id="cell-11" class="cell" data-page-layout="full">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>x <span class="op">=</span> <span class="st">"sugars_100g"</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>y <span class="op">=</span> <span class="st">"fat_100g"</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>chart <span class="op">=</span> (</span>
<span id="cb6-6"><a href="#cb6-6"></a>    alt.Chart(</span>
<span id="cb6-7"><a href="#cb6-7"></a>        df.<span class="bu">filter</span>(pl.col(<span class="st">"product_name"</span>).is_null().is_not()).select(x, y, c)</span>
<span id="cb6-8"><a href="#cb6-8"></a>        <span class="co"># .sample(5_000)</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>    )</span>
<span id="cb6-10"><a href="#cb6-10"></a>    .mark_point(clip<span class="op">=</span><span class="va">True</span>, filled<span class="op">=</span><span class="va">True</span>, opacity<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb6-11"><a href="#cb6-11"></a>    .encode(</span>
<span id="cb6-12"><a href="#cb6-12"></a>        x<span class="op">=</span>alt.X(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb6-13"><a href="#cb6-13"></a>        y<span class="op">=</span>alt.Y(<span class="ss">f"</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb6-14"><a href="#cb6-14"></a>        color<span class="op">=</span>color,</span>
<span id="cb6-15"><a href="#cb6-15"></a>        tooltip<span class="op">=</span>[<span class="st">"product_name:N"</span>],</span>
<span id="cb6-16"><a href="#cb6-16"></a>    )</span>
<span id="cb6-17"><a href="#cb6-17"></a>    .properties(width<span class="op">=</span><span class="dv">220</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb6-18"><a href="#cb6-18"></a>    .facet(facet<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">:N"</span>, columns<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb6-19"><a href="#cb6-19"></a>)</span>
<span id="cb6-20"><a href="#cb6-20"></a></span>
<span id="cb6-21"><a href="#cb6-21"></a>chart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Unsuprisingly, “D” and “E” grade products seem to contain more sugar and fat.</p>
<p>Let’s look at a histogram of the contained calories (per 100g) next.</p>
<div id="cell-14" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>alt.Chart(</span>
<span id="cb7-2"><a href="#cb7-2"></a>    df.select(<span class="st">"nutriscore_grade"</span>, <span class="st">"nutriscore_score"</span>, <span class="st">"energy-kcal_100g"</span>).<span class="bu">filter</span>(</span>
<span id="cb7-3"><a href="#cb7-3"></a>        pl.col(<span class="st">"energy-kcal_100g"</span>) <span class="op">&lt;</span> <span class="dv">1000</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    )  <span class="co"># .sample(5_000)</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>).mark_bar().encode(</span>
<span id="cb7-6"><a href="#cb7-6"></a>    x<span class="op">=</span>alt.X(<span class="st">"energy-kcal_100g:Q"</span>).<span class="bu">bin</span>(step<span class="op">=</span><span class="dv">10</span>),</span>
<span id="cb7-7"><a href="#cb7-7"></a>    y<span class="op">=</span>alt.Y(<span class="st">"count():Q"</span>),</span>
<span id="cb7-8"><a href="#cb7-8"></a>    color<span class="op">=</span>color,</span>
<span id="cb7-9"><a href="#cb7-9"></a>    row<span class="op">=</span><span class="st">"nutriscore_grade:N"</span>,</span>
<span id="cb7-10"><a href="#cb7-10"></a>).properties(</span>
<span id="cb7-11"><a href="#cb7-11"></a>    height<span class="op">=</span><span class="dv">150</span>, width<span class="op">=</span><span class="dv">700</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>).resolve_scale(</span>
<span id="cb7-13"><a href="#cb7-13"></a>    y<span class="op">=</span><span class="st">"independent"</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Interestingly, there is a spike at around 300kcal for the “A” grade foods, let’s look at what they are.</p>
<div id="cell-16" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>df.<span class="bu">filter</span>(pl.col(<span class="st">"nutriscore_grade"</span>) <span class="op">==</span> <span class="st">"A"</span>).<span class="bu">filter</span>(</span>
<span id="cb8-2"><a href="#cb8-2"></a>    pl.col(<span class="st">"energy-kcal_100g"</span>).is_between(<span class="dv">300</span>, <span class="dv">350</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a>).select(<span class="st">"product_name"</span>, <span class="st">"categories_en"</span>).sample(<span class="dv">20</span>)[<span class="st">"product_name"</span>].to_list()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This is containing a lot of pasta, cereal and rice, but also flour.</p>
<p>Let’s have a look at the top ten healthiest foods, according to their Nutriscore.</p>
<div id="cell-19" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>df.sort(<span class="st">"nutriscore_score"</span>).head(<span class="dv">10</span>)[<span class="st">"product_name"</span>].to_list()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And of course the ten least healthy foods.</p>
<div id="cell-21" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>df.sort(<span class="st">"nutriscore_score"</span>).tail(<span class="dv">10</span>)[<span class="st">"product_name"</span>].to_list()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This also makes sense I guess. So far so good.</p>
</section>
<section id="greenwashing" class="level1">
<h1>Greenwashing?</h1>
<p>Very frequently I can’t believe how a specific product got an “A” grade, like how does some chocolate get an “A” grade even though it is high of sugar. Is there any way that companies are cheating the system?</p>
<p>Let’s have a look at all the products that contain the word “choco” and see if we find something.</p>
<div id="cell-26" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>x <span class="op">=</span> <span class="st">"sugars_100g"</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>y <span class="op">=</span> <span class="st">"fat_100g"</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>(</span>
<span id="cb11-4"><a href="#cb11-4"></a>    alt.Chart(</span>
<span id="cb11-5"><a href="#cb11-5"></a>        df.<span class="bu">filter</span>(pl.col(<span class="st">"product_name"</span>).<span class="bu">str</span>.to_lowercase().<span class="bu">str</span>.contains(<span class="st">"choco"</span>))</span>
<span id="cb11-6"><a href="#cb11-6"></a>        .sort(<span class="st">"nutriscore_grade"</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a>        .select(x, y, <span class="st">"nutriscore_grade"</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a>    )</span>
<span id="cb11-9"><a href="#cb11-9"></a>    .mark_point(filled<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-10"><a href="#cb11-10"></a>    .encode(</span>
<span id="cb11-11"><a href="#cb11-11"></a>        x<span class="op">=</span>alt.X(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb11-12"><a href="#cb11-12"></a>        y<span class="op">=</span>alt.Y(<span class="ss">f"</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb11-13"><a href="#cb11-13"></a>        color<span class="op">=</span>color,</span>
<span id="cb11-14"><a href="#cb11-14"></a>    )</span>
<span id="cb11-15"><a href="#cb11-15"></a>    .properties(width<span class="op">=</span><span class="dv">300</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb11-16"><a href="#cb11-16"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Hmm so this seems to suggest that “A” grades are actually properly assigned when sugar and fat content is low.</p>
<div id="cell-28" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>x <span class="op">=</span> <span class="st">"sugars_100g"</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>y <span class="op">=</span> <span class="st">"fat_100g"</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>(</span>
<span id="cb12-4"><a href="#cb12-4"></a>    alt.Chart(</span>
<span id="cb12-5"><a href="#cb12-5"></a>        df.<span class="bu">filter</span>(pl.col(<span class="st">"product_name"</span>).<span class="bu">str</span>.to_lowercase().<span class="bu">str</span>.contains(<span class="st">"yoghurt"</span>))</span>
<span id="cb12-6"><a href="#cb12-6"></a>        .sort(<span class="st">"nutriscore_grade"</span>)</span>
<span id="cb12-7"><a href="#cb12-7"></a>        .select(x, y, <span class="st">"nutriscore_grade"</span>)</span>
<span id="cb12-8"><a href="#cb12-8"></a>    )</span>
<span id="cb12-9"><a href="#cb12-9"></a>    .mark_point(filled<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-10"><a href="#cb12-10"></a>    .encode(</span>
<span id="cb12-11"><a href="#cb12-11"></a>        x<span class="op">=</span>alt.X(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb12-12"><a href="#cb12-12"></a>        y<span class="op">=</span>alt.Y(<span class="ss">f"</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb12-13"><a href="#cb12-13"></a>        color<span class="op">=</span>color,</span>
<span id="cb12-14"><a href="#cb12-14"></a>    )</span>
<span id="cb12-15"><a href="#cb12-15"></a>    .properties(width<span class="op">=</span><span class="dv">300</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb12-16"><a href="#cb12-16"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>How about “sweet snacks” (a label in the data frame) in general?</p>
<div id="cell-30" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>x <span class="op">=</span> <span class="st">"sugars_100g"</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>y <span class="op">=</span> <span class="st">"fat_100g"</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>(</span>
<span id="cb13-4"><a href="#cb13-4"></a>    alt.Chart(</span>
<span id="cb13-5"><a href="#cb13-5"></a>        df.<span class="bu">filter</span>(</span>
<span id="cb13-6"><a href="#cb13-6"></a>            pl.col(<span class="st">"categories_en"</span>).<span class="bu">str</span>.to_lowercase().<span class="bu">str</span>.contains(<span class="st">"sweet snacks"</span>)</span>
<span id="cb13-7"><a href="#cb13-7"></a>        )</span>
<span id="cb13-8"><a href="#cb13-8"></a>        .sort(<span class="st">"nutriscore_grade"</span>)</span>
<span id="cb13-9"><a href="#cb13-9"></a>        .select(x, y, <span class="st">"nutriscore_grade"</span>)</span>
<span id="cb13-10"><a href="#cb13-10"></a>    )</span>
<span id="cb13-11"><a href="#cb13-11"></a>    .mark_point(filled<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span><span class="va">True</span>, opacity<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb13-12"><a href="#cb13-12"></a>    .encode(</span>
<span id="cb13-13"><a href="#cb13-13"></a>        x<span class="op">=</span>alt.X(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb13-14"><a href="#cb13-14"></a>        y<span class="op">=</span>alt.Y(<span class="ss">f"</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb13-15"><a href="#cb13-15"></a>        color<span class="op">=</span>color,</span>
<span id="cb13-16"><a href="#cb13-16"></a>    )</span>
<span id="cb13-17"><a href="#cb13-17"></a>    .properties(width<span class="op">=</span><span class="dv">300</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb13-18"><a href="#cb13-18"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>What about vegan labels?</p>
<div id="cell-32" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>x <span class="op">=</span> <span class="st">"sugars_100g"</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>y <span class="op">=</span> <span class="st">"fat_100g"</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>(</span>
<span id="cb14-4"><a href="#cb14-4"></a>    alt.Chart(</span>
<span id="cb14-5"><a href="#cb14-5"></a>        df.<span class="bu">filter</span>(</span>
<span id="cb14-6"><a href="#cb14-6"></a>            pl.col(<span class="st">"ingredients_analysis_tags"</span>).<span class="bu">str</span>.to_lowercase().<span class="bu">str</span>.contains(<span class="st">"vegan"</span>)</span>
<span id="cb14-7"><a href="#cb14-7"></a>        )</span>
<span id="cb14-8"><a href="#cb14-8"></a>        .sort(<span class="st">"nutriscore_grade"</span>)</span>
<span id="cb14-9"><a href="#cb14-9"></a>        .select(x, y, <span class="st">"nutriscore_grade"</span>)</span>
<span id="cb14-10"><a href="#cb14-10"></a>    )</span>
<span id="cb14-11"><a href="#cb14-11"></a>    .mark_point(filled<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-12"><a href="#cb14-12"></a>    .encode(</span>
<span id="cb14-13"><a href="#cb14-13"></a>        x<span class="op">=</span>alt.X(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb14-14"><a href="#cb14-14"></a>        y<span class="op">=</span>alt.Y(<span class="ss">f"</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb14-15"><a href="#cb14-15"></a>        color<span class="op">=</span>color,</span>
<span id="cb14-16"><a href="#cb14-16"></a>    )</span>
<span id="cb14-17"><a href="#cb14-17"></a>    .properties(width<span class="op">=</span><span class="dv">200</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb14-18"><a href="#cb14-18"></a>    .facet(facet<span class="op">=</span><span class="st">"nutriscore_grade:N"</span>, columns<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb14-19"><a href="#cb14-19"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next is protein vs.&nbsp;sugar.</p>
<div id="cell-34" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>x <span class="op">=</span> <span class="st">"sugars_100g"</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>y <span class="op">=</span> <span class="st">"proteins_100g"</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>(</span>
<span id="cb15-4"><a href="#cb15-4"></a>    alt.Chart(</span>
<span id="cb15-5"><a href="#cb15-5"></a>        df.<span class="bu">filter</span>(pl.col(<span class="st">"product_name"</span>).<span class="bu">str</span>.to_lowercase().<span class="bu">str</span>.contains(<span class="st">"choco"</span>))</span>
<span id="cb15-6"><a href="#cb15-6"></a>        .sort(<span class="st">"nutriscore_grade"</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a>        .select(x, y, <span class="st">"nutriscore_grade"</span>)</span>
<span id="cb15-8"><a href="#cb15-8"></a>    )</span>
<span id="cb15-9"><a href="#cb15-9"></a>    .mark_point(filled<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-10"><a href="#cb15-10"></a>    .encode(</span>
<span id="cb15-11"><a href="#cb15-11"></a>        x<span class="op">=</span>alt.X(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb15-12"><a href="#cb15-12"></a>        y<span class="op">=</span>alt.Y(<span class="ss">f"</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">:Q"</span>).scale(domain<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">100</span>)),</span>
<span id="cb15-13"><a href="#cb15-13"></a>        color<span class="op">=</span>color,</span>
<span id="cb15-14"><a href="#cb15-14"></a>    )</span>
<span id="cb15-15"><a href="#cb15-15"></a>    .properties(width<span class="op">=</span><span class="dv">200</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb15-16"><a href="#cb15-16"></a>    .facet(facet<span class="op">=</span><span class="st">"nutriscore_grade:N"</span>, columns<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb15-17"><a href="#cb15-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So no greenwashing? Need to continue this.</p>
</section>
<section id="correlations" class="level1">
<h1>Correlations</h1>
<p>Let’s see which of the nutrients correlate with the Nutriscore.</p>
<p>To do that, we pick all columns that contain ingredients about the nutrients and where at most 10% of the entries are null.</p>
<div id="cell-38" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>d <span class="op">=</span> (</span>
<span id="cb16-2"><a href="#cb16-2"></a>    (</span>
<span id="cb16-3"><a href="#cb16-3"></a>        df.select([c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> c.endswith(<span class="st">"_100g"</span>)]).null_count()</span>
<span id="cb16-4"><a href="#cb16-4"></a>        <span class="op">/</span> <span class="bu">len</span>(df)</span>
<span id="cb16-5"><a href="#cb16-5"></a>        <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>    )</span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>)[<span class="dv">0</span>].to_dict()</span>
<span id="cb16-9"><a href="#cb16-9"></a>columns <span class="op">=</span> [<span class="st">"nutriscore_score"</span>] <span class="op">+</span> [key <span class="cf">for</span> key, values <span class="kw">in</span> d.items() <span class="cf">if</span> values[<span class="dv">0</span>]]</span>
<span id="cb16-10"><a href="#cb16-10"></a></span>
<span id="cb16-11"><a href="#cb16-11"></a>display(</span>
<span id="cb16-12"><a href="#cb16-12"></a>    df.select(columns)</span>
<span id="cb16-13"><a href="#cb16-13"></a>    .to_pandas()</span>
<span id="cb16-14"><a href="#cb16-14"></a>    .corr()[[<span class="st">"nutriscore_score"</span>]]</span>
<span id="cb16-15"><a href="#cb16-15"></a>    .iloc[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>, :]</span>
<span id="cb16-16"><a href="#cb16-16"></a>    .sort_values(<span class="st">"nutriscore_score"</span>)</span>
<span id="cb16-17"><a href="#cb16-17"></a>    .style.background_gradient(cmap<span class="op">=</span><span class="st">"RdBu"</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-18"><a href="#cb16-18"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So (saturated) fat is the best indicator for a Nutriscore.</p>
<p>The obvious next question is, how well can we predict this. We’ll use simple <a href="https://scikit-learn.org/stable/modules/tree.html#decision-trees">Decision Trees</a>.</p>
<div id="cell-40" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>columns_for_fitting <span class="op">=</span> [</span>
<span id="cb17-2"><a href="#cb17-2"></a>    <span class="st">"energy-kcal_100g"</span>,</span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="st">"energy_100g"</span>,</span>
<span id="cb17-4"><a href="#cb17-4"></a>    <span class="st">"fat_100g"</span>,</span>
<span id="cb17-5"><a href="#cb17-5"></a>    <span class="st">"saturated-fat_100g"</span>,</span>
<span id="cb17-6"><a href="#cb17-6"></a>    <span class="st">"carbohydrates_100g"</span>,</span>
<span id="cb17-7"><a href="#cb17-7"></a>    <span class="st">"sugars_100g"</span>,</span>
<span id="cb17-8"><a href="#cb17-8"></a>    <span class="st">"proteins_100g"</span>,</span>
<span id="cb17-9"><a href="#cb17-9"></a>    <span class="st">"salt_100g"</span>,</span>
<span id="cb17-10"><a href="#cb17-10"></a>    <span class="st">"sodium_100g"</span>,</span>
<span id="cb17-11"><a href="#cb17-11"></a>    <span class="co"># "nutrition-score-fr_100g",</span></span>
<span id="cb17-12"><a href="#cb17-12"></a>]</span>
<span id="cb17-13"><a href="#cb17-13"></a></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="co"># columns_for_fitting =columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-41" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>y <span class="op">=</span> df.select(<span class="st">"nutriscore_score"</span>).to_numpy().flatten()</span>
<span id="cb18-2"><a href="#cb18-2"></a>logger.info(y.shape)</span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a>X <span class="op">=</span> df.select(</span>
<span id="cb18-5"><a href="#cb18-5"></a>    [</span>
<span id="cb18-6"><a href="#cb18-6"></a>        c</span>
<span id="cb18-7"><a href="#cb18-7"></a>        <span class="cf">for</span> c <span class="kw">in</span> columns_for_fitting</span>
<span id="cb18-8"><a href="#cb18-8"></a>        <span class="cf">if</span> (c <span class="op">!=</span> <span class="st">"nutriscore_score"</span> <span class="kw">and</span> c <span class="op">!=</span> <span class="st">"nutrition-score-fr_100g"</span>)</span>
<span id="cb18-9"><a href="#cb18-9"></a>    ]</span>
<span id="cb18-10"><a href="#cb18-10"></a>).to_numpy()</span>
<span id="cb18-11"><a href="#cb18-11"></a>logger.info(X.shape)</span>
<span id="cb18-12"><a href="#cb18-12"></a></span>
<span id="cb18-13"><a href="#cb18-13"></a></span>
<span id="cb18-14"><a href="#cb18-14"></a>logger.info(<span class="st">"Keep only data that has no nans."</span>)</span>
<span id="cb18-15"><a href="#cb18-15"></a></span>
<span id="cb18-16"><a href="#cb18-16"></a>select <span class="op">=</span> np.<span class="bu">sum</span>(np.isnan(X), axis<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>y <span class="op">=</span> y[select]</span>
<span id="cb18-18"><a href="#cb18-18"></a>X <span class="op">=</span> X[select, :]</span>
<span id="cb18-19"><a href="#cb18-19"></a>logger.info(y.shape)</span>
<span id="cb18-20"><a href="#cb18-20"></a>logger.info(X.shape)</span>
<span id="cb18-21"><a href="#cb18-21"></a></span>
<span id="cb18-22"><a href="#cb18-22"></a></span>
<span id="cb18-23"><a href="#cb18-23"></a>transformer <span class="op">=</span> Normalizer().fit(X)</span>
<span id="cb18-24"><a href="#cb18-24"></a></span>
<span id="cb18-25"><a href="#cb18-25"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb18-26"><a href="#cb18-26"></a>    transformer.transform(X), y, test_size<span class="op">=</span><span class="fl">0.20</span>, random_state<span class="op">=</span><span class="dv">2023</span></span>
<span id="cb18-27"><a href="#cb18-27"></a>)</span>
<span id="cb18-28"><a href="#cb18-28"></a></span>
<span id="cb18-29"><a href="#cb18-29"></a></span>
<span id="cb18-30"><a href="#cb18-30"></a>clf <span class="op">=</span> tree.DecisionTreeRegressor(max_depth<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb18-31"><a href="#cb18-31"></a>clf <span class="op">=</span> clf.fit(X_train, y_train)</span>
<span id="cb18-32"><a href="#cb18-32"></a></span>
<span id="cb18-33"><a href="#cb18-33"></a></span>
<span id="cb18-34"><a href="#cb18-34"></a>df_tree <span class="op">=</span> pl.concat(</span>
<span id="cb18-35"><a href="#cb18-35"></a>    [</span>
<span id="cb18-36"><a href="#cb18-36"></a>        pl.DataFrame(</span>
<span id="cb18-37"><a href="#cb18-37"></a>            {</span>
<span id="cb18-38"><a href="#cb18-38"></a>                <span class="st">"actual score"</span>: y_test,</span>
<span id="cb18-39"><a href="#cb18-39"></a>                <span class="st">"predicted score"</span>: clf.predict(X_test),</span>
<span id="cb18-40"><a href="#cb18-40"></a>                <span class="st">"label"</span>: <span class="st">"test"</span>,</span>
<span id="cb18-41"><a href="#cb18-41"></a>            }</span>
<span id="cb18-42"><a href="#cb18-42"></a>        ),</span>
<span id="cb18-43"><a href="#cb18-43"></a>        pl.DataFrame(</span>
<span id="cb18-44"><a href="#cb18-44"></a>            {</span>
<span id="cb18-45"><a href="#cb18-45"></a>                <span class="st">"actual score"</span>: y_train,</span>
<span id="cb18-46"><a href="#cb18-46"></a>                <span class="st">"predicted score"</span>: clf.predict(X_train),</span>
<span id="cb18-47"><a href="#cb18-47"></a>                <span class="st">"label"</span>: <span class="st">"train"</span>,</span>
<span id="cb18-48"><a href="#cb18-48"></a>            }</span>
<span id="cb18-49"><a href="#cb18-49"></a>        ),</span>
<span id="cb18-50"><a href="#cb18-50"></a>    ]</span>
<span id="cb18-51"><a href="#cb18-51"></a>).with_columns(err<span class="op">=</span>pl.col(<span class="st">"predicted score"</span>) <span class="op">-</span> pl.col(<span class="st">"actual score"</span>))</span>
<span id="cb18-52"><a href="#cb18-52"></a></span>
<span id="cb18-53"><a href="#cb18-53"></a></span>
<span id="cb18-54"><a href="#cb18-54"></a>chart_v1 <span class="op">=</span> (</span>
<span id="cb18-55"><a href="#cb18-55"></a>    alt.Chart(df_tree)</span>
<span id="cb18-56"><a href="#cb18-56"></a>    .mark_point(filled<span class="op">=</span><span class="va">True</span>, opacity<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb18-57"><a href="#cb18-57"></a>    .encode(</span>
<span id="cb18-58"><a href="#cb18-58"></a>        x<span class="op">=</span><span class="st">"actual score:Q"</span>,</span>
<span id="cb18-59"><a href="#cb18-59"></a>        y<span class="op">=</span><span class="st">"predicted score:Q"</span>,</span>
<span id="cb18-60"><a href="#cb18-60"></a>        <span class="co"># y="err:Q",</span></span>
<span id="cb18-61"><a href="#cb18-61"></a>        color<span class="op">=</span><span class="st">"label:N"</span>,</span>
<span id="cb18-62"><a href="#cb18-62"></a>        column<span class="op">=</span><span class="st">"label:N"</span>,</span>
<span id="cb18-63"><a href="#cb18-63"></a>    )</span>
<span id="cb18-64"><a href="#cb18-64"></a>    .properties(width<span class="op">=</span><span class="dv">300</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb18-65"><a href="#cb18-65"></a>)</span>
<span id="cb18-66"><a href="#cb18-66"></a></span>
<span id="cb18-67"><a href="#cb18-67"></a>display(chart_v1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A little underwhelming. Maybe adding information on the categories helps. Let’s find the top 20 labels and one-hot-encode them.</p>
<div id="cell-43" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>lol_categories <span class="op">=</span> (</span>
<span id="cb19-2"><a href="#cb19-2"></a>    df.select(<span class="st">"categories_en"</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a>    .with_columns(pl.col(<span class="st">"categories_en"</span>).<span class="bu">str</span>.split(<span class="st">","</span>))[<span class="st">"categories_en"</span>]</span>
<span id="cb19-4"><a href="#cb19-4"></a>    .to_list()</span>
<span id="cb19-5"><a href="#cb19-5"></a>)</span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a></span>
<span id="cb19-8"><a href="#cb19-8"></a>categories <span class="op">=</span> []</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="cf">for</span> l <span class="kw">in</span> lol_categories[:<span class="dv">100</span>]:</span>
<span id="cb19-10"><a href="#cb19-10"></a>    categories.extend(l)</span>
<span id="cb19-11"><a href="#cb19-11"></a></span>
<span id="cb19-12"><a href="#cb19-12"></a></span>
<span id="cb19-13"><a href="#cb19-13"></a>hist <span class="op">=</span> <span class="bu">dict</span>(collections.Counter(categories))</span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a>df_hist <span class="op">=</span> (</span>
<span id="cb19-16"><a href="#cb19-16"></a>    pl.DataFrame(</span>
<span id="cb19-17"><a href="#cb19-17"></a>        {</span>
<span id="cb19-18"><a href="#cb19-18"></a>            <span class="st">"categorie"</span>: [key <span class="cf">for</span> key, _ <span class="kw">in</span> hist.items()],</span>
<span id="cb19-19"><a href="#cb19-19"></a>            <span class="st">"count"</span>: [value <span class="cf">for</span> _, value <span class="kw">in</span> hist.items()],</span>
<span id="cb19-20"><a href="#cb19-20"></a>        }</span>
<span id="cb19-21"><a href="#cb19-21"></a>    )</span>
<span id="cb19-22"><a href="#cb19-22"></a>    .sort(<span class="st">"count"</span>, descending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-23"><a href="#cb19-23"></a>    .head(<span class="dv">20</span>)</span>
<span id="cb19-24"><a href="#cb19-24"></a>)</span>
<span id="cb19-25"><a href="#cb19-25"></a><span class="bu">print</span>(df_hist[<span class="st">"categorie"</span>].to_list())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Alright so we can now one-hot-encode these. Let’s run the classifier again, but now we add these labels. We can also check the correlation again.</p>
<div id="cell-45" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>df_one_hot <span class="op">=</span> df.with_columns(</span>
<span id="cb20-2"><a href="#cb20-2"></a>    (pl.col(<span class="st">"categories_en"</span>).<span class="bu">str</span>.to_lowercase().<span class="bu">str</span>.contains(x.lower()))</span>
<span id="cb20-3"><a href="#cb20-3"></a>    .cast(<span class="bu">int</span>)</span>
<span id="cb20-4"><a href="#cb20-4"></a>    .alias(<span class="ss">f"1hot__</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-5"><a href="#cb20-5"></a>    <span class="cf">for</span> x <span class="kw">in</span> df_hist[<span class="st">"categorie"</span>].to_list()</span>
<span id="cb20-6"><a href="#cb20-6"></a>)</span>
<span id="cb20-7"><a href="#cb20-7"></a>columns_one_hot <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df_one_hot.columns <span class="cf">if</span> <span class="st">"1hot"</span> <span class="kw">in</span> c]</span>
<span id="cb20-8"><a href="#cb20-8"></a>logger.info(columns_one_hot)</span>
<span id="cb20-9"><a href="#cb20-9"></a></span>
<span id="cb20-10"><a href="#cb20-10"></a>y <span class="op">=</span> df_one_hot.select(<span class="st">"nutriscore_score"</span>).to_numpy().flatten()</span>
<span id="cb20-11"><a href="#cb20-11"></a>logger.info(y.shape)</span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a>X <span class="op">=</span> df_one_hot.select(</span>
<span id="cb20-14"><a href="#cb20-14"></a>    [</span>
<span id="cb20-15"><a href="#cb20-15"></a>        c</span>
<span id="cb20-16"><a href="#cb20-16"></a>        <span class="cf">for</span> c <span class="kw">in</span> columns_for_fitting <span class="op">+</span> columns_one_hot</span>
<span id="cb20-17"><a href="#cb20-17"></a>        <span class="cf">if</span> (c <span class="op">!=</span> <span class="st">"nutriscore_score"</span> <span class="kw">and</span> c <span class="op">!=</span> <span class="st">"nutrition-score-fr_100g"</span>)</span>
<span id="cb20-18"><a href="#cb20-18"></a>    ]</span>
<span id="cb20-19"><a href="#cb20-19"></a>).to_numpy()</span>
<span id="cb20-20"><a href="#cb20-20"></a>logger.info(X.shape)</span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a></span>
<span id="cb20-23"><a href="#cb20-23"></a>logger.info(<span class="st">"Keep only data that has no nans."</span>)</span>
<span id="cb20-24"><a href="#cb20-24"></a></span>
<span id="cb20-25"><a href="#cb20-25"></a>select <span class="op">=</span> np.<span class="bu">sum</span>(np.isnan(X), axis<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb20-26"><a href="#cb20-26"></a>y <span class="op">=</span> y[select]</span>
<span id="cb20-27"><a href="#cb20-27"></a>X <span class="op">=</span> X[select, :]</span>
<span id="cb20-28"><a href="#cb20-28"></a>logger.info(y.shape)</span>
<span id="cb20-29"><a href="#cb20-29"></a>logger.info(X.shape)</span>
<span id="cb20-30"><a href="#cb20-30"></a></span>
<span id="cb20-31"><a href="#cb20-31"></a>d <span class="op">=</span> (</span>
<span id="cb20-32"><a href="#cb20-32"></a>    (</span>
<span id="cb20-33"><a href="#cb20-33"></a>        df_one_hot.select(</span>
<span id="cb20-34"><a href="#cb20-34"></a>            [c <span class="cf">for</span> c <span class="kw">in</span> df_one_hot.columns <span class="cf">if</span> c.endswith(<span class="st">"_100g"</span>)]</span>
<span id="cb20-35"><a href="#cb20-35"></a>        ).null_count()</span>
<span id="cb20-36"><a href="#cb20-36"></a>        <span class="op">/</span> <span class="bu">len</span>(df)</span>
<span id="cb20-37"><a href="#cb20-37"></a>        <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb20-38"><a href="#cb20-38"></a>    )</span>
<span id="cb20-39"><a href="#cb20-39"></a>    <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb20-40"><a href="#cb20-40"></a>)[<span class="dv">0</span>].to_dict()</span>
<span id="cb20-41"><a href="#cb20-41"></a></span>
<span id="cb20-42"><a href="#cb20-42"></a>columns <span class="op">=</span> (</span>
<span id="cb20-43"><a href="#cb20-43"></a>    [<span class="st">"nutriscore_score"</span>]</span>
<span id="cb20-44"><a href="#cb20-44"></a>    <span class="op">+</span> [key <span class="cf">for</span> key, values <span class="kw">in</span> d.items() <span class="cf">if</span> values[<span class="dv">0</span>]]</span>
<span id="cb20-45"><a href="#cb20-45"></a>    <span class="op">+</span> columns_one_hot</span>
<span id="cb20-46"><a href="#cb20-46"></a>)</span>
<span id="cb20-47"><a href="#cb20-47"></a></span>
<span id="cb20-48"><a href="#cb20-48"></a>display(</span>
<span id="cb20-49"><a href="#cb20-49"></a>    df_one_hot.select(columns)</span>
<span id="cb20-50"><a href="#cb20-50"></a>    .to_pandas()</span>
<span id="cb20-51"><a href="#cb20-51"></a>    .corr()[[<span class="st">"nutriscore_score"</span>]]</span>
<span id="cb20-52"><a href="#cb20-52"></a>    .iloc[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>, :]</span>
<span id="cb20-53"><a href="#cb20-53"></a>    .sort_values(<span class="st">"nutriscore_score"</span>)</span>
<span id="cb20-54"><a href="#cb20-54"></a>    .style.background_gradient(cmap<span class="op">=</span><span class="st">"RdBu"</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-55"><a href="#cb20-55"></a>)</span>
<span id="cb20-56"><a href="#cb20-56"></a></span>
<span id="cb20-57"><a href="#cb20-57"></a></span>
<span id="cb20-58"><a href="#cb20-58"></a>logger.info(X.shape)</span>
<span id="cb20-59"><a href="#cb20-59"></a>transformer <span class="op">=</span> Normalizer().fit(X)</span>
<span id="cb20-60"><a href="#cb20-60"></a></span>
<span id="cb20-61"><a href="#cb20-61"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb20-62"><a href="#cb20-62"></a>    transformer.transform(X), y, test_size<span class="op">=</span><span class="fl">0.20</span>, random_state<span class="op">=</span><span class="dv">2023</span></span>
<span id="cb20-63"><a href="#cb20-63"></a>)</span>
<span id="cb20-64"><a href="#cb20-64"></a></span>
<span id="cb20-65"><a href="#cb20-65"></a>clf <span class="op">=</span> tree.DecisionTreeRegressor(max_depth<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb20-66"><a href="#cb20-66"></a>clf <span class="op">=</span> clf.fit(X_train, y_train)</span>
<span id="cb20-67"><a href="#cb20-67"></a></span>
<span id="cb20-68"><a href="#cb20-68"></a></span>
<span id="cb20-69"><a href="#cb20-69"></a>df_tree_one_hot <span class="op">=</span> pl.concat(</span>
<span id="cb20-70"><a href="#cb20-70"></a>    [</span>
<span id="cb20-71"><a href="#cb20-71"></a>        pl.DataFrame(</span>
<span id="cb20-72"><a href="#cb20-72"></a>            {</span>
<span id="cb20-73"><a href="#cb20-73"></a>                <span class="st">"actual score"</span>: y_test,</span>
<span id="cb20-74"><a href="#cb20-74"></a>                <span class="st">"predicted score"</span>: clf.predict(X_test),</span>
<span id="cb20-75"><a href="#cb20-75"></a>                <span class="st">"label"</span>: <span class="st">"test"</span>,</span>
<span id="cb20-76"><a href="#cb20-76"></a>            }</span>
<span id="cb20-77"><a href="#cb20-77"></a>        ),</span>
<span id="cb20-78"><a href="#cb20-78"></a>        pl.DataFrame(</span>
<span id="cb20-79"><a href="#cb20-79"></a>            {</span>
<span id="cb20-80"><a href="#cb20-80"></a>                <span class="st">"actual score"</span>: y_train,</span>
<span id="cb20-81"><a href="#cb20-81"></a>                <span class="st">"predicted score"</span>: clf.predict(X_train),</span>
<span id="cb20-82"><a href="#cb20-82"></a>                <span class="st">"label"</span>: <span class="st">"train"</span>,</span>
<span id="cb20-83"><a href="#cb20-83"></a>            }</span>
<span id="cb20-84"><a href="#cb20-84"></a>        ),</span>
<span id="cb20-85"><a href="#cb20-85"></a>    ]</span>
<span id="cb20-86"><a href="#cb20-86"></a>).with_columns(err<span class="op">=</span>pl.col(<span class="st">"predicted score"</span>) <span class="op">-</span> pl.col(<span class="st">"actual score"</span>))</span>
<span id="cb20-87"><a href="#cb20-87"></a></span>
<span id="cb20-88"><a href="#cb20-88"></a></span>
<span id="cb20-89"><a href="#cb20-89"></a>new_chart <span class="op">=</span> (</span>
<span id="cb20-90"><a href="#cb20-90"></a>    alt.Chart(df_tree_one_hot)</span>
<span id="cb20-91"><a href="#cb20-91"></a>    .mark_point(filled<span class="op">=</span><span class="va">True</span>, opacity<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb20-92"><a href="#cb20-92"></a>    .encode(</span>
<span id="cb20-93"><a href="#cb20-93"></a>        x<span class="op">=</span><span class="st">"actual score:Q"</span>,</span>
<span id="cb20-94"><a href="#cb20-94"></a>        y<span class="op">=</span><span class="st">"predicted score:Q"</span>,</span>
<span id="cb20-95"><a href="#cb20-95"></a>        <span class="co"># y="err:Q",</span></span>
<span id="cb20-96"><a href="#cb20-96"></a>        color<span class="op">=</span><span class="st">"label:N"</span>,</span>
<span id="cb20-97"><a href="#cb20-97"></a>        column<span class="op">=</span><span class="st">"label:N"</span>,</span>
<span id="cb20-98"><a href="#cb20-98"></a>    )</span>
<span id="cb20-99"><a href="#cb20-99"></a>    .properties(width<span class="op">=</span><span class="dv">300</span>, height<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb20-100"><a href="#cb20-100"></a>)</span>
<span id="cb20-101"><a href="#cb20-101"></a></span>
<span id="cb20-102"><a href="#cb20-102"></a></span>
<span id="cb20-103"><a href="#cb20-103"></a>chart_v1 <span class="op">&amp;</span> new_chart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-46" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>df_tree_full <span class="op">=</span> pl.concat(</span>
<span id="cb21-2"><a href="#cb21-2"></a>    [</span>
<span id="cb21-3"><a href="#cb21-3"></a>        df_tree.with_columns(pl.lit(<span class="st">"simple"</span>).alias(<span class="st">"model"</span>)),</span>
<span id="cb21-4"><a href="#cb21-4"></a>        df_tree_one_hot.with_columns(pl.lit(<span class="st">"one_hot"</span>).alias(<span class="st">"model"</span>)),</span>
<span id="cb21-5"><a href="#cb21-5"></a>    ]</span>
<span id="cb21-6"><a href="#cb21-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-47" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>alt.Chart(df_tree_full).mark_bar().encode(</span>
<span id="cb22-2"><a href="#cb22-2"></a>    x<span class="op">=</span>alt.X(<span class="st">"err:Q"</span>).<span class="bu">bin</span>(step<span class="op">=</span><span class="dv">2</span>).axis(values<span class="op">=</span>np.arange(<span class="op">-</span><span class="dv">30</span>, <span class="dv">35</span>, <span class="dv">5</span>)),</span>
<span id="cb22-3"><a href="#cb22-3"></a>    y<span class="op">=</span>alt.Y(<span class="st">"count():Q"</span>),</span>
<span id="cb22-4"><a href="#cb22-4"></a>    color<span class="op">=</span><span class="st">"label:N"</span>,</span>
<span id="cb22-5"><a href="#cb22-5"></a>    row<span class="op">=</span><span class="st">"model:N"</span>,</span>
<span id="cb22-6"><a href="#cb22-6"></a>    column<span class="op">=</span><span class="st">"label:N"</span>,</span>
<span id="cb22-7"><a href="#cb22-7"></a>).properties(width<span class="op">=</span><span class="dv">300</span>, height<span class="op">=</span><span class="dv">200</span>).resolve_scale(y<span class="op">=</span><span class="st">"independent"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-48" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>df_tree_full.groupby(<span class="st">"label"</span>, <span class="st">"model"</span>).agg(</span>
<span id="cb23-2"><a href="#cb23-2"></a>    err_min<span class="op">=</span>pl.col(<span class="st">"err"</span>).<span class="bu">min</span>(),</span>
<span id="cb23-3"><a href="#cb23-3"></a>    err_mean<span class="op">=</span>pl.col(<span class="st">"err"</span>).mean(),</span>
<span id="cb23-4"><a href="#cb23-4"></a>    err_median<span class="op">=</span>pl.col(<span class="st">"err"</span>).median(),</span>
<span id="cb23-5"><a href="#cb23-5"></a>    err_std<span class="op">=</span>pl.col(<span class="st">"err"</span>).std(),</span>
<span id="cb23-6"><a href="#cb23-6"></a>    err_max<span class="op">=</span>pl.col(<span class="st">"err"</span>).<span class="bu">max</span>(),</span>
<span id="cb23-7"><a href="#cb23-7"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This looks fine for now, with the one-hot-encoded model, the error is mostly acceptable.</p>
<p>However, let’s try one more time, this time with classification instead of regression.</p>
<div id="cell-50" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>df_one_hot <span class="op">=</span> df.with_columns(</span>
<span id="cb24-2"><a href="#cb24-2"></a>    (pl.col(<span class="st">"categories_en"</span>).<span class="bu">str</span>.to_lowercase().<span class="bu">str</span>.contains(x.lower()))</span>
<span id="cb24-3"><a href="#cb24-3"></a>    .cast(<span class="bu">int</span>)</span>
<span id="cb24-4"><a href="#cb24-4"></a>    .alias(<span class="ss">f"1hot__</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-5"><a href="#cb24-5"></a>    <span class="cf">for</span> x <span class="kw">in</span> df_hist[<span class="st">"categorie"</span>].to_list()</span>
<span id="cb24-6"><a href="#cb24-6"></a>)</span>
<span id="cb24-7"><a href="#cb24-7"></a>columns_one_hot <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df_one_hot.columns <span class="cf">if</span> <span class="st">"1hot"</span> <span class="kw">in</span> c]</span>
<span id="cb24-8"><a href="#cb24-8"></a></span>
<span id="cb24-9"><a href="#cb24-9"></a>y <span class="op">=</span> df_one_hot.select(<span class="st">"nutriscore_grade"</span>).to_numpy().flatten()</span>
<span id="cb24-10"><a href="#cb24-10"></a></span>
<span id="cb24-11"><a href="#cb24-11"></a>X <span class="op">=</span> df_one_hot.select(</span>
<span id="cb24-12"><a href="#cb24-12"></a>    [</span>
<span id="cb24-13"><a href="#cb24-13"></a>        c</span>
<span id="cb24-14"><a href="#cb24-14"></a>        <span class="cf">for</span> c <span class="kw">in</span> columns_for_fitting <span class="op">+</span> columns_one_hot</span>
<span id="cb24-15"><a href="#cb24-15"></a>        <span class="cf">if</span> (c <span class="op">!=</span> <span class="st">"nutriscore_score"</span> <span class="kw">and</span> c <span class="op">!=</span> <span class="st">"nutrition-score-fr_100g"</span>)</span>
<span id="cb24-16"><a href="#cb24-16"></a>    ]</span>
<span id="cb24-17"><a href="#cb24-17"></a>).to_numpy()</span>
<span id="cb24-18"><a href="#cb24-18"></a></span>
<span id="cb24-19"><a href="#cb24-19"></a></span>
<span id="cb24-20"><a href="#cb24-20"></a>select <span class="op">=</span> np.<span class="bu">sum</span>(np.isnan(X), axis<span class="op">=</span><span class="dv">1</span>) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb24-21"><a href="#cb24-21"></a>y <span class="op">=</span> y[select]</span>
<span id="cb24-22"><a href="#cb24-22"></a>X <span class="op">=</span> X[select, :]</span>
<span id="cb24-23"><a href="#cb24-23"></a>logger.info(y.shape)</span>
<span id="cb24-24"><a href="#cb24-24"></a>logger.info(X.shape)</span>
<span id="cb24-25"><a href="#cb24-25"></a></span>
<span id="cb24-26"><a href="#cb24-26"></a></span>
<span id="cb24-27"><a href="#cb24-27"></a>clf <span class="op">=</span> tree.DecisionTreeClassifier(max_depth<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb24-28"><a href="#cb24-28"></a>transformer <span class="op">=</span> Normalizer().fit(X)</span>
<span id="cb24-29"><a href="#cb24-29"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb24-30"><a href="#cb24-30"></a>    transformer.transform(X), y, test_size<span class="op">=</span><span class="fl">0.80</span>, random_state<span class="op">=</span><span class="dv">2023</span></span>
<span id="cb24-31"><a href="#cb24-31"></a>)</span>
<span id="cb24-32"><a href="#cb24-32"></a>clf.fit(X_train, y_train)</span>
<span id="cb24-33"><a href="#cb24-33"></a></span>
<span id="cb24-34"><a href="#cb24-34"></a>y_test_predict <span class="op">=</span> clf.predict(X_test)</span>
<span id="cb24-35"><a href="#cb24-35"></a>y_train_predict <span class="op">=</span> clf.predict(X_train)</span>
<span id="cb24-36"><a href="#cb24-36"></a></span>
<span id="cb24-37"><a href="#cb24-37"></a>logger.info(<span class="st">"Training confusion matrix"</span>)</span>
<span id="cb24-38"><a href="#cb24-38"></a><span class="co"># cm = confusion_matrix(y_test, y_test_predict, labels=["A", "B", "C", "D", "E"])</span></span>
<span id="cb24-39"><a href="#cb24-39"></a>cm <span class="op">=</span> confusion_matrix(y_train, y_train_predict, labels<span class="op">=</span>[<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>])</span>
<span id="cb24-40"><a href="#cb24-40"></a><span class="co">"""Confusion matrix whose i-th row and j-th column entry indicates the number of samples with true label being i-th class and predicted label being j-th class."""</span></span>
<span id="cb24-41"><a href="#cb24-41"></a>letter <span class="op">=</span> {<span class="dv">4</span>: <span class="st">"A"</span>, <span class="dv">3</span>: <span class="st">"B"</span>, <span class="dv">2</span>: <span class="st">"C"</span>, <span class="dv">1</span>: <span class="st">"D"</span>, <span class="dv">0</span>: <span class="st">"E"</span>}</span>
<span id="cb24-42"><a href="#cb24-42"></a>display(</span>
<span id="cb24-43"><a href="#cb24-43"></a>    pl.DataFrame(cm)</span>
<span id="cb24-44"><a href="#cb24-44"></a>    .rename(</span>
<span id="cb24-45"><a href="#cb24-45"></a>        mapping<span class="op">=</span>{</span>
<span id="cb24-46"><a href="#cb24-46"></a>            <span class="ss">f"column_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>: <span class="ss">f"predicts </span><span class="sc">{</span>letter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb24-47"><a href="#cb24-47"></a>            <span class="cf">for</span> i, letter <span class="kw">in</span> <span class="bu">zip</span>([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>], [<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>])</span>
<span id="cb24-48"><a href="#cb24-48"></a>        }</span>
<span id="cb24-49"><a href="#cb24-49"></a>    )</span>
<span id="cb24-50"><a href="#cb24-50"></a>    .with_columns(</span>
<span id="cb24-51"><a href="#cb24-51"></a>        pl.col(<span class="st">"predicts A"</span>)</span>
<span id="cb24-52"><a href="#cb24-52"></a>        .rank()</span>
<span id="cb24-53"><a href="#cb24-53"></a>        .cast(<span class="bu">int</span>)</span>
<span id="cb24-54"><a href="#cb24-54"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> r: letter[r <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb24-55"><a href="#cb24-55"></a>        .alias(<span class="st">"true label"</span>)</span>
<span id="cb24-56"><a href="#cb24-56"></a>    )</span>
<span id="cb24-57"><a href="#cb24-57"></a>    .select(</span>
<span id="cb24-58"><a href="#cb24-58"></a>        <span class="st">"true label"</span>,</span>
<span id="cb24-59"><a href="#cb24-59"></a>        <span class="st">"predicts A"</span>,</span>
<span id="cb24-60"><a href="#cb24-60"></a>        <span class="st">"predicts B"</span>,</span>
<span id="cb24-61"><a href="#cb24-61"></a>        <span class="st">"predicts C"</span>,</span>
<span id="cb24-62"><a href="#cb24-62"></a>        <span class="st">"predicts D"</span>,</span>
<span id="cb24-63"><a href="#cb24-63"></a>        <span class="st">"predicts E"</span>,</span>
<span id="cb24-64"><a href="#cb24-64"></a>    )</span>
<span id="cb24-65"><a href="#cb24-65"></a>    .to_pandas()</span>
<span id="cb24-66"><a href="#cb24-66"></a>    .style.background_gradient()</span>
<span id="cb24-67"><a href="#cb24-67"></a>)</span>
<span id="cb24-68"><a href="#cb24-68"></a></span>
<span id="cb24-69"><a href="#cb24-69"></a></span>
<span id="cb24-70"><a href="#cb24-70"></a>logger.info(<span class="st">"Testing confusion matrix"</span>)</span>
<span id="cb24-71"><a href="#cb24-71"></a>cm <span class="op">=</span> confusion_matrix(y_test, y_test_predict, labels<span class="op">=</span>[<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>])</span>
<span id="cb24-72"><a href="#cb24-72"></a><span class="co"># cm = confusion_matrix(y_train, y_train_predict, labels=["A", "B", "C", "D", "E"])</span></span>
<span id="cb24-73"><a href="#cb24-73"></a><span class="co">"""Confusion matrix whose i-th row and j-th column entry indicates the number of samples with true label being i-th class and predicted label being j-th class."""</span></span>
<span id="cb24-74"><a href="#cb24-74"></a>letter <span class="op">=</span> {<span class="dv">4</span>: <span class="st">"A"</span>, <span class="dv">3</span>: <span class="st">"B"</span>, <span class="dv">2</span>: <span class="st">"C"</span>, <span class="dv">1</span>: <span class="st">"D"</span>, <span class="dv">0</span>: <span class="st">"E"</span>}</span>
<span id="cb24-75"><a href="#cb24-75"></a>display(</span>
<span id="cb24-76"><a href="#cb24-76"></a>    pl.DataFrame(cm)</span>
<span id="cb24-77"><a href="#cb24-77"></a>    .rename(</span>
<span id="cb24-78"><a href="#cb24-78"></a>        mapping<span class="op">=</span>{</span>
<span id="cb24-79"><a href="#cb24-79"></a>            <span class="ss">f"column_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>: <span class="ss">f"predicts </span><span class="sc">{</span>letter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb24-80"><a href="#cb24-80"></a>            <span class="cf">for</span> i, letter <span class="kw">in</span> <span class="bu">zip</span>([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>], [<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>])</span>
<span id="cb24-81"><a href="#cb24-81"></a>        }</span>
<span id="cb24-82"><a href="#cb24-82"></a>    )</span>
<span id="cb24-83"><a href="#cb24-83"></a>    .with_columns(</span>
<span id="cb24-84"><a href="#cb24-84"></a>        pl.col(<span class="st">"predicts A"</span>)</span>
<span id="cb24-85"><a href="#cb24-85"></a>        .rank()</span>
<span id="cb24-86"><a href="#cb24-86"></a>        .cast(<span class="bu">int</span>)</span>
<span id="cb24-87"><a href="#cb24-87"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> r: letter[r <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb24-88"><a href="#cb24-88"></a>        .alias(<span class="st">"true label"</span>)</span>
<span id="cb24-89"><a href="#cb24-89"></a>    )</span>
<span id="cb24-90"><a href="#cb24-90"></a>    .select(</span>
<span id="cb24-91"><a href="#cb24-91"></a>        <span class="st">"true label"</span>,</span>
<span id="cb24-92"><a href="#cb24-92"></a>        <span class="st">"predicts A"</span>,</span>
<span id="cb24-93"><a href="#cb24-93"></a>        <span class="st">"predicts B"</span>,</span>
<span id="cb24-94"><a href="#cb24-94"></a>        <span class="st">"predicts C"</span>,</span>
<span id="cb24-95"><a href="#cb24-95"></a>        <span class="st">"predicts D"</span>,</span>
<span id="cb24-96"><a href="#cb24-96"></a>        <span class="st">"predicts E"</span>,</span>
<span id="cb24-97"><a href="#cb24-97"></a>    )</span>
<span id="cb24-98"><a href="#cb24-98"></a>    .to_pandas()</span>
<span id="cb24-99"><a href="#cb24-99"></a>    .style.background_gradient()</span>
<span id="cb24-100"><a href="#cb24-100"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>This was a good first deep dive into the data. Nothing suspicous as of yet. No obvious green washing and prediction works reasonably well (as expected). To be continued.!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>